<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jarvis AI - Document Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
</head>
<body>
  <div class="jarvis-container">
    <!-- Header -->
    <header class="header">
      <div class="branding">
        <span class="logo">ü§ñ</span>
        <div class="text">
          <h1>Jarvis AI</h1>
          <p>Your Intelligent Document Assistant</p>
        </div>
      </div>
    </header>

    <!-- Chat Box -->
    <main id="chat-box" class="chat-box">
      <div class="msg bot">
        <b>Jarvis:</b> Hello <b>Jotiba</b> üëã <br>
        Upload your PDF and ask me anything ‚Äî summaries, insights, or explanations.
      </div>
    </main>

    <!-- Input Controls -->
    <div class="controls">
      <input id="user-input" type="text" placeholder="Type your question..." autocomplete="off" />
      <button id="send-btn" class="btn send">Send</button>
    </div>

    <!-- Upload Controls -->
    <div class="upload-section">
      <input id="file-input" type="file" accept=".pdf" />
      <button id="upload-btn" class="btn upload">üìé Upload</button>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>Developed by <b>Jotiba Ugale</b> ¬∑ Powered by <span class="brand">Mistral ¬∑ Ollama</span></p>
    </footer>
  </div>

  <!-- Scripts -->
  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const fileInput = document.getElementById("file-input");
    const uploadBtn = document.getElementById("upload-btn");
    const userId = "jotiba";

    const render = (text) => DOMPurify.sanitize(marked.parse(text || ""));

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.innerHTML = role === "bot" ? `<b>Jarvis:</b> ${render(text)}` : `<b>You:</b> ${render(text)}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTyping() {
      const div = document.createElement("div");
      div.className = "msg bot typing";
      div.innerHTML = `<b>Jarvis:</b> <span class="dots"><span>.</span><span>.</span><span>.</span></span>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      appendMessage("user", text);
      input.value = "";
      const typing = showTyping();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, user_id: userId }),
        });
        const data = await res.json();
        typing.remove();
        appendMessage("bot", data.response);
      } catch (error) {
        typing.remove();
        appendMessage("bot", "‚ö†Ô∏è Could not reach Jarvis. Please try again.");
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", (e) => e.key === "Enter" && sendMessage());

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return alert("Please select a PDF file first.");
      appendMessage("user", `Uploading <b>${file.name}</b>...`);
      const typing = showTyping();

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();
        typing.remove();
        appendMessage("bot", data.message || "‚úÖ File uploaded successfully!");
      } catch (error) {
        typing.remove();
        appendMessage("bot", "‚ö†Ô∏è File upload failed. Try again.");
      }
    });
  </script>
</body>
</html>
